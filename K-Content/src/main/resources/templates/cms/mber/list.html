<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="ko">
<head>
<th:block th:replace="~{/include/new-admin-head :: newAdminHead}"></th:block>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
	rel="stylesheet">
<style>
.mber-table .badge {
	color: white;
	padding: 10px;
	font-weight: normal;
}



.table-layout table th, .table-layout table td {
	border: none;
	text-align: center;
	white-space: nowrap;
}

.page-link {
	color: #000;
	background-color: #fff;
	border: 1px solid #ccc;
}

.page-item.active .page-link {
	z-index: 1;
	color: #555;
	font-weight: bold;
	background-color: #f1f1f1;
	border-color: #ccc;
}

.page-link:focus, .page-link:hover {
	color: #000;
	background-color: #fafafa;
	border-color: #ccc;
}



.table>:not(caption)>*>* {
	background-color: unset;
}

.mber-table td .btn {
	height: 20px;
	border: 1px solid #14dbc8;
	padding: 16px 12px;
}
</style>
</head>
<body>
	<header th:insert="~{/include/admin-body-header :: adminNavBar}"></header>
	<div class="container mb-3">
		<div class="content">
			<div class="row">
				<div class="col-md-12">

					<div class="menu fw-bold">회원관리</div>
					<div id="mberTable"
						class="table-layout mber-table table table-group-divider">


						<form id="searchForm" class="input-group mt-3 mb-3">
							<input type="text" id="search-input" placeholder="검색어를 입력하세요"
								class="form-control">
							<button type="submit" class="btn" onclick="searchButton()">
								<i class="fa-solid fa-magnifying-glass"></i>
							</button>
						</form>
						<table class="table">
							<thead>
								<tr>
									<th class="serial">#</th>
									<th>계정구분</th>
									<th>아이디</th>
									<th>이름</th>
									<th>이메일</th>
									<th>성별</th>
									<th>생년월일</th>
									<th>전화번호</th>
									<th>가입일시</th>
									<th>수정일시</th>
									<th>계정상태</th>
									<th>상태수정</th>
								</tr>
							</thead>
							<tbody>

							</tbody>
						</table>
					</div>
				</div>
			</div>
			<div class="row">
				<nav aria-label="Page navigation"
					class="d-flex justify-content-center mb-3">
					<ul class="pagination">
						<li class="page-item" th:if="${nowPageBlock>1}"><a
							class="page-link" th:href="@{/mber/list/__${startPage-1}__}"
							aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
							<a class="page-link prepage" aria-label="Previous"> <span
								aria-hidden="true">&laquo;</span>
						</a></li>

						<li class="page-item"
							th:each="i: ${#numbers.sequence(startPage, endPage)}"
							th:classappend="${i==nowPage}?active"><a class="page-link"
							th:href="@{/mber/list/__${i}__}">[[${i}]]</a></li>

						<li class="page-item" th:if="${nowPageBlock<totalPageBlock}">
							<a class="page-link" th:href="@{/mber/list/__${endPage+1}__}"
							aria-label="Next"><span aria-hidden="true">&raquo;</span></a> <a
							class="page-link nexpage" aria-label="Next"> <span
								aria-hidden="true">&raquo;</span>
						</a>
						</li>
					</ul>
				</nav>
			</div>

		</div>
	</div>
	<script>
		// 현재 페이지를 저장할 변수 추가
		var currentPage = "[[${nowPage}]]";
		var totalPageBlock = "[[${totalPage}]]";
		$(document).ready(function() {
			// 페이지 로딩 시 초기 데이터 가져오기
			loadMberData(currentPage);

		});
		// 페이지네이션 링크 클릭 시 데이터 다시 가져오기
		$(".pagination").on("click", "a", function(event) {
			event.preventDefault(); // 기본 이벤트 취소 (페이지 이동 방지)
			var page = $(this).attr("href").split("/").pop(); // 클릭한 링크의 페이지 번호 가져오기
			loadMberData(page); // 데이터 비동기로 가져오기
		});

		function loadMberData(page) {
			currentPage = page; // 현재 페이지 업데이트
			$
					.ajax({
						type : 'GET',
						url : '/cs/mber/list/' + page,
						dataType : 'json',
						success : function(data) {
							// 회원 정보를 표시할 HTML을 생성
							var html = '';
							data
									.forEach(function(mber, index) {
										var rownum = (page - 1) * 10 + index
												+ 1;
										html += '<tr>';
										html += '<td>' + rownum++ + '</td>';
										html += '<td>' + mber.mberRole
												+ '</td>';
										html += '<td>' + mber.mberId + '</td>';
										html += '<td>' + mber.mberName
												+ '</td>';
										html += '<td>' + mber.mberEmail
												+ '</td>';
										html += '<td>' + mber.mberGenderCode
												+ '</td>';
										if (mber.mberBirth == null) {
											html += '<td>-</td>';
										} else {
											html += '<td>' + mber.mberBirth
													+ '</td>';
										}
										if (mber.mberPhone == null) {
											html += '<td>-</td>';
										} else {
											html += '<td>' + mber.mberPhone
													+ '</td>';
										}
										html += '<td>' + mber.mberRegistDate
												+ '</td>';
										if (mber.mberUpdateDate == null) {
											html += '<td>-</td>';
										} else {
											html += '<td>'
													+ mber.mberUpdateDate
													+ '</td>';
										}
										if (mber.mberStat == '비활성화') {
										html += '<td class="fw-bold text-danger">' + mber.mberStat
												+ '</td>';
										} else {
											html += '<td class="fw-bold">' + mber.mberStat
											+ '</td>';
										}
										html += '<td>';

										if (mber.mberRole != '관리자') {
										if (mber.mberStat == '비활성화') {
												html += '<button class="btn" data-mber-id="'
														+ mber.mberId
														+ '" onclick="changeStatus(this.getAttribute(\'data-mber-id\'), \'C0202\')">변경</button>';
											} else if (mber.mberStat == '활성화') {
												html += '<button class="btn" data-mber-id="'
													+ mber.mberId
													+ '" onclick="changeStatus(this.getAttribute(\'data-mber-id\'), \'C0201\')">변경</button>';
										} 
										}
										html += '</td>';
										html += '</tr>';
									});

							// 회원 리스트 테이블 업데이트
							$('#mberTable tbody').html(html);
								
						},
						error : function() {
							alert('데이터를 불러오는데 실패했습니다.');
						}
					});
		}
		function updatePagination() {
			// 기존 페이지네이션 링크 지우기
			$(".pagination").empty();

			// totalPageBlock을 기반으로 페이지네이션 링크 추가
			for (var i = startPage; i <= endPage; i++) { // 수정된 부분
				var pageLink = $('<a>');
				pageLink.text(i);
				pageLink.attr('href', '/cs/mber/list/' + i);
				if (currentPage === i) {
					pageLink.addClass('active');
				}
				$(".pagination").append($('<li>').append(pageLink));
			}
		}
	</script>
	<script>
		function changeStatus(mberId, newStatus) {
			$.ajax({
				type : 'POST',
				url : '/mber/changestat',
				data : {
					mberId : mberId,
					newStatus : newStatus
				},
				success : function(response) {
					if (response.success) {
						loadMberData(currentPage);
					} else {
						alert('상태 변경 실패했습니다.');
					}
				},
				error : function() {
					alert('서버 오류로 인해 상태 변경에 실패했습니다.');
				}
			});
		}
	</script>
</body>
</html>